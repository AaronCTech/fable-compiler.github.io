<html><head><title>Fable Blog</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,300,600,700|Roboto+Mono"/><link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/><link rel="stylesheet" type="text/css" href="/css/styles.css"/><link rel="stylesheet" type="text/css" href="/css/highlight.css"/><link rel="shortcut icon" href="/img/fable.ico"/></head><body><nav class="navbar"><div class="navbar-brand"><div class="navbar-item title is-4">Fable</div><div class="navbar-burger" data-target="navMenu"><span></span><span></span><span></span></div></div><div id="navMenu" class=" navbar-menu"><div class="navbar-start"><a class=" navbar-item" href="/">Home</a><a class=" navbar-item" href="/repl">REPL</a><a class=" navbar-item is-active" href="/blog">Blog</a><a class=" navbar-item" href="/docs">Docs</a><a class=" navbar-item" href="/faq">FAQ</a><a class=" navbar-item" href="/fableconf">FableConf</a></div><div class="navbar-end"><div class="navbar-item"><div class="field is-grouped"><div class="control"><a class="button twitter" href="https://twitter.com/FableCompiler"><span class="icon"><i class="fa fa-twitter"></i></span><span>Share the love!</span></a></div><div class="control"><a class="button github" href="https://gitter.im/fable-compiler/Fable"><span class="icon"><i class="fa fa-comments"></i></span><span>Chat</span></a></div><div class="control"><a class="button github" href="https://github.com/fable-compiler/Fable"><span class="icon"><i class="fa fa-github"></i></span><span>Contribute</span></a></div></div></div></div></div></nav><div class="markdown blog" style="overflow:hidden"><section class="hero fable-header"><div class="hero-body"><div class="container"><div class="columns is-vcentered"><div class="column"><img class="fable-logo" src="/img/fable_logo.png"/></div><div class="column    has-text-right        "><h1 class="title is-1">Fable.React 5</h1><h1 class="subtitle is-4">Componentize your functions!</h1></div></div></div></div></section><div style="margin-top:1.6rem"><div class="columns"><div class="column"></div><div class="column is-two-thirds"><div class="content" style="margin:5px"><p>Fable.React 5 has just been released with new additions to help write your Fable/Elmish apps with React. Before going into detail, I want to thank Julien Roncaglia (@vbfox) who has contributed most of the ideas for this release since <a href="https://www.youtube.com/watch?v=9VJoaNoutm4">his talk at latest FableConf</a>, as well as the React team for their great work in the latest releases. And also to Don Syme and the other F# compiler contributors who have added features like anonymous records to make F# even more suitable to write UIs!</p>
<blockquote>
<p>Note this release depends on Fable.Core 3 and Fable.Browser.Dom, please <a href="https://fable.io/blog/Announcing-2-2.html">read the previous post</a> to learn about the changes in the ecosystem.</p>
</blockquote>
<p>So far, in Elmish applications the most common way to render the UI was to use simple functions, which is great and shows the power of Functional Programming for building UIs. However, in order to use React features like keeping internal state or getting a reference to the actual element in the browser&#39;s DOM, we had to declare a full class component. It worked, but required quite a bit of code to turn the view functions into classes and override the proper methods.</p>
<p>This is about to end since React 16.8 and the introduction of <a href="https://reactjs.org/docs/hooks-overview.html">hooks</a> which gives function components the same possibilities as class components have. Fable.React 5 focus on this and, in fact, from now on it may be difficult to tell functions from function components apart, so let&#39;s learn more about what distinguishes them.</p>
<h2><a name="functions-vs-function-components" class="anchor" href="#functions-vs-function-components">Functions vs Function Components</a></h2><p>Functions are <strong>just functions</strong> (I&#39;m also in a position to confirm water is wet): each time you call them, their code is run, you get a value in return and forget about them.</p>
<pre><code class="language-fsharp"><span class="hljs-keyword">open</span> Fable.React

<span class="hljs-keyword">let</span> myView (props: MyProps) =
    div [] [str props.message]

<span class="hljs-comment">// We could just replace the call to myView with</span>
<span class="hljs-comment">// the body of the function and get the same result</span>
<span class="hljs-keyword">let</span> rootView msg =
    myView { message = msg }</code></pre>
<p>On the other hand, function components are <strong>actual entities</strong> in the Virtual DOM, which means you can visualize them in the React dev tools or include triggers for different moments of the component&#39;s life cycle. In Fable.React 5 we use the <code>FunctionComponent</code> helper to declare them. The signature is the same as that of a function <code>&#39;Props -&gt; ReactElement</code> so, as a convention, we will use <strong>upper case to name them</strong> and highlight them over simple functions.</p>
<pre><code class="language-fsharp"><span class="hljs-keyword">let</span> MyView =
    FunctionComponent.Of(<span class="hljs-keyword">fun</span> (props: Props) -&gt;
        div [] [str props.message])

<span class="hljs-keyword">let</span> rootView msg =
    MyView { message = msg }</code></pre>
<blockquote>
<p>This distinction is not exactly the same in React, because React apps usually use JSX for the UI code so the difference radicates in <em>the way you call the function</em>. Because Fable apps just use F#, we need the <code>FunctionComponent</code> wrapper to get the desired behavior.</p>
</blockquote>
<p>When to use a function component? Whenever you need:</p>
<ul>
<li>To <strong>skip rendering</strong> the component if the props haven&#39;t changed. This is specially important when using central state management like Elmish, because every time our UI model is updated a new render for the whole app will be triggered. Skip the parts of the UI tree that don&#39;t need to change with the <code>memoizeWith</code> parameter, which receives a function to check if the old and new props are equal. Fable.React 5 also provides the <code>equalsButFunctions</code> helper which doesn&#39;t take into account the functions in the props object (useful in Elmish apps where we usually pass the <code>dispatch</code> function down the UI tree).</li>
</ul>
<pre><code class="language-fsharp"><span class="hljs-keyword">let</span> MiView  =
    FunctionComponent.Of((<span class="hljs-keyword">fun</span> p -&gt; ..), memoizeWith = equalsButFunctions)</code></pre>
<ul>
<li><p>To keep some <strong>internal state</strong> for the component, which can be done using React&#39;s state hook. Hooks also give you more capabilities concerning the component&#39;s life cycle. Read more about them in the next section.</p>
</li>
<li><p>To <strong>visualize the component</strong> in React dev tools, very helpful for debugging. Use the <code>displayName</code> parameter to set a custom name for the component in React dev tools.</p>
</li>
</ul>
<h2><a name="react-hooks" class="anchor" href="#react-hooks">React Hooks</a></h2><p>In Elmish apps we keep a central model for our whole app so most of the times we don&#39;t need stateful React components.</p>
<pre><code class="language-fsharp"><span class="hljs-keyword">let</span> view (props: {| count: int; dispatch: int -&gt; unit |}) =
      button
        [ OnClick (<span class="hljs-keyword">fun</span> _ -&gt; props.count + <span class="hljs-number">1</span> |&gt; props.dispatch) ]
        [ str <span class="hljs-string">"Times clicked: "</span>; ofInt props.count ]</code></pre>
<p>In some occasions however we don&#39;t want to include some very specific internal state in the global model (e.g. whether a dropdown is open or closed), and in order to do that we need to deploy a full class. The example above would become:</p>
<pre><code class="language-fsharp"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Props</span> </span>= { initCount: int }
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">State</span> </span>= { count: int }

<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">MyView</span></span>(props) =
    <span class="hljs-keyword">inherit</span> Component&lt;Props, State&gt;(props)
    <span class="hljs-keyword">do</span> <span class="hljs-keyword">base</span>.setInitState({ count = props.initCount })

    <span class="hljs-keyword">override</span> this.render() =
          button
            [ OnClick (<span class="hljs-keyword">fun</span> _ -&gt;
                this.setState(<span class="hljs-keyword">fun</span> s _ -&gt; { s <span class="hljs-keyword">with</span> count = s.count + <span class="hljs-number">1</span> })) ]
            [ str <span class="hljs-string">"Times clicked: "</span>; ofInt this.state.count ]</code></pre>
<p>The situation gets more complicated when we also want to trigger some code at specific points in the life cycle, keep a reference to value outside the component state, etc. Thankfully, since React 16.8 we can use hooks to empower functions with all these capabilities. Now adding state to a component is as simple as:</p>
<pre><code class="language-fsharp"><span class="hljs-keyword">let</span> view (props: {| initCount: int |}) =
      <span class="hljs-keyword">let</span> state = Hooks.useState(props.initCount) <span class="hljs-comment">// This is where the magic happens</span>
      button
        [ OnClick (<span class="hljs-keyword">fun</span> _ -&gt; state.update(<span class="hljs-keyword">fun</span> s -&gt; s + <span class="hljs-number">1</span>)) ]
        [ str <span class="hljs-string">"Times clicked: "</span>; ofInt state.current ]</code></pre>
<p>I won&#39;t explain hooks in detail because <a href="https://reactjs.org/docs/hooks-overview.html">React documentation is already a fantastic source</a> for that. Fable.React 5 provides bindings for the most commonly used hooks (<code>useState</code>, <code>useEffect</code>, <code>useRef</code>, <code>useMemo</code>...) matching React&#39;s API for the most part, except for a few cases where a different name is necessary to comply with F# overloading rules. I will only show another example combining <code>useEffect</code> and <code>useRef</code> to detect a click <em>outside</em> our component, something that beforehand required quite a bit of code.</p>
<pre><code class="language-fsharp"><span class="hljs-keyword">open</span> Browser.Types

<span class="hljs-keyword">let</span> attachEvent (f: Event-&gt;unit) (node: Node) (eventType: string) =
    node.addEventListener(eventType, f)
    { <span class="hljs-keyword">new</span> System.IDisposable <span class="hljs-keyword">with</span>
        <span class="hljs-keyword">member</span> __.Dispose() = node.removeEventListener(eventType, f) }

<span class="hljs-keyword">let</span> view props =
    <span class="hljs-comment">// Keep a value ref during component's life cycle, initialized to None</span>
    <span class="hljs-keyword">let</span> selfRef = Hooks.useRef None

    <span class="hljs-comment">// Passing an empty array for dependencies tells React the effect should</span>
    <span class="hljs-comment">// only run when mounting (and the disposable when unmounting)</span>
    Hooks.useEffectDisposable((<span class="hljs-keyword">fun</span> () -&gt;
        (Browser.Dom.document, <span class="hljs-string">"mousedown"</span>) ||&gt; attachEvent (<span class="hljs-keyword">fun</span> ev -&gt;
            <span class="hljs-keyword">let</span> menuEl: Element = selfRef.current.Value
            <span class="hljs-keyword">if</span> not(menuEl.contains(ev.target :?&gt; _)) <span class="hljs-keyword">then</span>
                printfn <span class="hljs-string">"Clicked outside!"</span>)
    ), [||])

    button
        <span class="hljs-comment">// We can pass the ref object directly to the new RefHook prop</span>
        <span class="hljs-comment">// to get a reference to the actual button element in the browser's doom</span>
        [ RefHook selfRef
          OnClick (<span class="hljs-keyword">fun</span> _ -&gt; printfn <span class="hljs-string">"Clicked inside!"</span>) ]
        [ str <span class="hljs-string">"Click me"</span> ]</code></pre>
<h2><a name="type-safe-css-props" class="anchor" href="#type-safe-css-props">Type-safe CSS props</a></h2><p>The following CSS props now accept a union type instead of a simple string for better type safety and discoverability. Thanks to Zaid-Ajaj for this contribution!</p>
<ul>
<li>Display</li>
<li>Position</li>
<li>TextAlign</li>
<li>AlignContent</li>
<li>AlignItems</li>
<li>AlignSelf</li>
</ul>
<pre><code class="language-fsharp">div [ Display DisplayOptions.Flex ] [ ]</code></pre>
<h2><a name="code-splitting" class="anchor" href="#code-splitting">Code Splitting</a></h2><p>Fable.React 5 also includes initial support for &quot;code splitting&quot;, that is, split your JS bundle in order to defer the download of parts that are not immediately accessible to the user (a very handy feature in Single Page Applications). So far, this has been quite tricky in Fable apps: we had to create a separate project and import it manually using a string. Fable.React 5 includes <code>FunctionComponent.Lazy</code> which can automatically defer the download of the code for a React component with minimum changes to your code.</p>
<blockquote>
<p>IMPORTANT: For this feature to work you need <code>fable-compiler</code> (npm) 2.3 or higher.</p>
</blockquote>
<pre><code class="language-fsharp"><span class="hljs-comment">// About.fs</span>
<span class="hljs-keyword">let</span> view (props: {| model: Model; dispatch: Msg-&gt;unit |}) = ..

<span class="hljs-comment">// Router.fs</span>
<span class="hljs-keyword">let</span> AboutPage =
    FunctionComponent.Lazy(
        About.view, <span class="hljs-comment">// Pass a direct reference to the view function in the external file</span>
        fallback = div [] [str <span class="hljs-string">"Loading..."</span>])

<span class="hljs-keyword">let</span> view page =
    <span class="hljs-keyword">match</span> page <span class="hljs-keyword">with</span>
    | Home -&gt; HomePage {| .. |}
    <span class="hljs-comment">// The code for About.fs will not be downloaded until</span>
    <span class="hljs-comment">// the user selects the "About" page</span>
    | About -&gt; AboutPage {| .. |}</code></pre>
<p>You need also to make sure your webpack config includes the following:</p>
<pre><code class="language-js">    optimization: {
        <span class="hljs-attr">splitChunks</span>: {
            <span class="hljs-attr">chunks</span>: <span class="hljs-string">"all"</span>
        },
    },</code></pre>
<p>As you&#39;ve seen, you need to pass a <strong>direct reference to the external function</strong> as first argument to <code>FunctionComponent.Lazy</code> (avoid indirections like pipes, etc) so Fable can detect the path to the external file. Also, <strong>avoid other static references to the external file</strong> as this will pull the external code into the main bundle ruining the effect of code splitting. In Elmish apps, you&#39;ll usually have to add a reference to the <code>update</code> function of the external component. This makes it difficult to completely defer the download of code for the whole component (the state logic will get bundled in the main chunk), but if you separate the code for the component&#39;s state and view into different files, as it&#39;s common practice in Elmish apps, you can still defer the download of external resources needed for the view like CSS, JS libraries, etc. Have a look at <a href="https://github.com/MangelMaxime/fulma-demo/pull/27">this PR for a real-world example</a>.</p>
<p>Another trick to avoid static references is to use an <strong>anonymous record for the props of the external view function</strong>, so Fable doesn&#39;t need to refer to the constructor of a declared record when passing the props.</p>
<hr>
<p>Those are the most important new features in Fable.React 5 and I hope they help make your development experience with Fable and Elmish much more enjoyable. Looking forward to seeing the awesome projects you&#39;ll build with this!</p>
</div></div><div class="column"></div></div></div></div><footer><p>Fable <a href="https://github.com/fable-compiler/Fable">source code</a> is licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.</p></footer><script>
document.addEventListener('DOMContentLoaded', function () {
  var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  if ($navbarBurgers.length > 0) {
    $navbarBurgers.forEach(function ($el) {
      $el.addEventListener('click', function () {
        var target = $el.dataset.target;
        var $target = document.getElementById(target);
        $el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }
});</script></body></html>